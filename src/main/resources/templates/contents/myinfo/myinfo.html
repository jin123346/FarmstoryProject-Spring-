<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<html xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<script th:src="@{/js/utils.js}"></script>
<script type="text/javascript" th:src="@{/js/modifyinfo.js}" defer></script>
<section class="myinfo">
    <form th:action="@{/user/update}" method="post">
        <table border="1">
            <caption>회원정보 설정</caption>
            <tr>
                <td>아이디</td>
                <td>
                    <input type="text" name="uid" th:value="${#authentication.principal.user.uid}" readonly/>
                </td>
            </tr>
            <tr>
                <td>비밀번호</td>
                <td>
                    <input type="password" name="pass" class="inputPass" placeholder="비밀번호 입력"/>
                    <span id="resultPass"></span> <!-- 비밀번호 유효성 메시지 -->
                </td>
            </tr>
            <tr>
                <td>비밀번호 확인</td>
                <td>
                    <input type="password" name="pass2" class="inputPass" placeholder="비밀번호 입력 확인"/>
                    <button type="button" class="btn_modifty" id="modifyPassBtn">비밀번호 수정</button>
                    <span id="resultPass2"></span> <!-- 비밀번호 확인 메시지 -->
                </td>
            </tr>
            <tr>
                <td>회원가입날짜</td>
                <td><span sec:authentication="principal.user.regDate"></span></td>

            </tr>
        </table>
        <table border="1">
            <caption>개인정보 수정</caption>
            <tr>
                <td>이름</td>
                <td>
                    <input type="text" name="name" placeholder="이름 입력" th:value="${#authentication.principal.user.name}" />
                    <span class="resultName"></span>
                </td>
            </tr>
            <tr>
                <td>별명</td>
                <td>

                    <p>공백없이 한글, 영문, 숫자만 입력가능</p>
                    <!-- 로그인한 사용자의 별명 출력 -->
                    <input type="text" name="nick" placeholder="별명 입력" th:value="${#authentication.principal.user.nick}" />
                    <button type="button" id="btnCheckNick" data-type="nick"><img th:src="@{/images/user/chk_id.gif}" alt="중복확인"/></button>
                    <span id="resultNick"></span>
                </td>
            </tr>
            <tr>
                <td>E-Mail</td>
                <td>
                    <!-- 로그인한 사용자의 이메일 출력 -->
                    <input type="email"  class="inputEmail" name="email" placeholder="이메일 입력" th:value="${#authentication.principal.user.email}" />
                    <button type="button" id="btnCheckEmail" data-type="email"><img th:src="@{/images/user/chk_auth.gif}" alt="인증번호 받기"/></button>
                    <span class="resultEmail"></span>
                    <div class="auth">
                        <input type="text" name="auth" class="inputEmailCode" placeholder="인증번호 입력"/>
                        <button type="button" id="btnCheckEmailCode"  ><img th:src="@{/images/user/chk_confirm.gif}" alt="확인"/></button>
                    </div>
                </td>

            </tr>
            <tr>
                <td>휴대폰</td>
                <td>
                    <!-- 로그인한 사용자의 휴대폰 번호 출력 -->
                    <input type="text" name="hp" placeholder="- 포함 13자리 입력" th:value="${#authentication.principal.user.hp}" minlength="13" maxlength="13" />
                    <span class="resultHp"></span>

                </td>
            </tr>
            <tr>
                <td>주소</td>
                <td>
                    <div>
                        <!-- 로그인한 사용자의 우편번호 출력 -->
                        <input  type="text" name="zip" id="inputZip" placeholder="우편번호" th:value="${#authentication.principal.user.zip}" readonly/>
                        <button type="button" class="btnZip" onclick="postcode()"><img th:src="@{/images/user/chk_post.gif}" alt=""></button>
                        <!-- 로그인한 사용자의 주소 출력 -->
                        <input type="text" name="addr1" id="inputAddr1" placeholder="주소를 검색하세요." th:value="${#authentication.principal.user.addr1}" readonly/>                    </div>
                        <input type="text" name="addr2" id="inputAddr2" placeholder="상세주소를 입력하세요." th:value="${#authentication.principal.user.addr2}" />



                </td>
            </tr>
            <tr>
                <td>회원탈퇴</td>
                <td class="form_group quit">
                    <button type="button" class="btn_quit"><p>탈퇴하기</p></button>
                </td>
            </tr>
        </table>

            <div class="button_container">
                <button type="button" class="btn-cancel">취소</button>
                <button type="submit" class="btn_submit">회원정보 수정</button>
            </div>
            <div>
                <span id="resultMessage"></span> <!-- 회원 정보 수정 결과 메시지 표시 -->

            </div>
    </form>

</section>
<script>
    document.getElementById("modifyPassBtn").addEventListener("click", function () {
        const passInput = document.querySelector("input[name='pass']");
        const passConfirmInput = document.querySelector("input[name='pass2']");
        const resultPass = document.getElementById("resultPass");
        const resultPass2 = document.getElementById("resultPass2");
        const passwordMessage = document.getElementById("passwordMessage"); // 비밀번호 변경 메시지

        const newPassword = passInput.value;
        const confirmPassword = passConfirmInput.value;

        // 비밀번호 유효성 검사 정규식 (5~16자, 숫자/문자/특수문자 포함)
        const rePass = /^(?=.*[a-zA-z])(?=.*[0-9])(?=.*[$`~!@$!%*#^?&\\(\\)\-_=+]).{5,16}$/;

        // 비밀번호 유효성 검사
        if (!newPassword.match(rePass)) {
            resultPass2.textContent = "비밀번호 형식에 맞지 않습니다.";
            resultPass2.style.color = "red";
            return;
        } else {

        }

        // 비밀번호 확인 일치 여부 검사
        if (newPassword !== confirmPassword) {
            resultPass2.textContent = "비밀번호가 일치하지 않습니다.";
            resultPass2.style.color = "red";
            return;
        } else {
            resultPass2.textContent = "사용 가능한 비밀번호 입니다.";
            resultPass2.style.color = "green";
        }

        // 비밀번호 변경 API 호출
        fetch('/api/myinfo/modifypass', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ newpass: newPassword })
        })
            .then(response => response.json())
            .then(data => {
                if (data.result) {
                    passwordMessage.textContent = "비밀번호가 성공적으로 변경되었습니다.";
                    passwordMessage.style.color = "green";
                } else {
                    passwordMessage.textContent = "비밀번호 변경에 실패했습니다.";
                    passwordMessage.style.color = "red";
                }
            })
            .catch(error => {
                console.error("비밀번호 변경 중 오류 발생:", error);
                passwordMessage.textContent = "오류가 발생했습니다. 다시 시도해 주세요.";
                passwordMessage.style.color = "red";
            });
    });





    // 별명 중복 확인 처리
    document.getElementById("btnCheckNick").addEventListener("click", function () {
        const nick = document.querySelector("input[name='nick']").value;

        fetch(`/api/user/check-nick?nick=${encodeURIComponent(nick)}`)//??????
            .then(response => response.json())
            .then(data => {
                const resultNick = document.getElementById("resultNick");
                if (data.result) {
                    resultNick.textContent = "이미 사용 중인 별명입니다."; //메시지로떠라 ㅡㅡ
                    resultNick.style.color = "red";
                } else {
                    resultNick.textContent = "사용 가능한 별명입니다.";
                    resultNick.style.color = "green";
                }
            })
            .catch(error => {
                const resultNick = document.getElementById("resultNick");
                resultNick.textContent = "별명 확인 중 오류가 발생했습니다."; // 에러 메시지 표시
                resultNick.style.color = "red";
                console.error(error);
            });
    });

    // 회원 정보 수정
    document.querySelector(".btn_submit").addEventListener("click", function (e) {
        e.preventDefault();  // 기본 폼 제출 막기

        const data = {
            pass: document.querySelector("input[name='pass']").value,
            nick: document.querySelector("input[name='nick']").value,
            zip: document.querySelector("input[name='zip']").value,
            addr1: document.querySelector("input[name='addr1']").value,
            addr2: document.querySelector("input[name='addr2']").value,
            email: document.querySelector("input[name='email']").value,
            hp: document.querySelector("input[name='hp']").value,
        };

        // AJAX 요청으로 회원 정보 수정 API 호출
        fetch("/api/user/update", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                const resultMessage = document.getElementById("resultMessage");

                if (response.ok) {
                    resultMessage.textContent = "회원 정보가 성공적으로 수정되었습니다."; // 성공 메시지 표시
                    resultMessage.style.color = "green";
                    alert("회원수정이 성공했습니다.")
                    window.location.href = "/";  // 수정 완료 후 리다이렉트
                } else {
                    resultMessage.textContent = "회원 정보 수정에 실패했습니다."; // 실패 메시지 표시
                    resultMessage.style.color = "red";
                }
            })
            .catch(error => {
                const resultMessage = document.getElementById("resultMessage");
                resultMessage.textContent = "오류가 발생했습니다: " + error.message; // 에러 메시지 표시
                resultMessage.style.color = "red";
                console.error(error);
            });
    });
</script>
